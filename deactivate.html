<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HisHealth 계정 삭제 (회원 탈퇴)</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 20px; max-width: 500px; margin: 0 auto; background-color: #f9f9f9; }
        .container { background-color: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { color: #d32f2f; text-align: center; margin-bottom: 20px; }
        p { color: #555; line-height: 1.6; margin-bottom: 20px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; color: #333; }
        input { width: 100%; padding: 10px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; font-size: 16px; }
        button { width: 100%; background-color: #d32f2f; color: white; border: none; padding: 12px; cursor: pointer; font-size: 16px; border-radius: 4px; font-weight: bold; margin-top: 10px; }
        button:hover { background-color: #b71c1c; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        #message { margin-top: 20px; padding: 10px; border-radius: 4px; text-align: center; display: none; }
        .success { background-color: #e8f5e9; color: #2e7d32; border: 1px solid #c8e6c9; }
        .error { background-color: #ffebee; color: #c62828; border: 1px solid #ffcdd2; }
    </style>
</head>
<body>
    <div class="container">
        <h1>계정 영구 삭제</h1>
        <p>
            앱을 더 이상 사용하지 않거나 로그인이 불가능한 경우, 이 페이지를 통해 계정과 모든 데이터를 <strong>즉시 영구 삭제</strong>할 수 있습니다.<br><br>
            삭제된 데이터(걸음 수 기록 등)는 <strong>절대 복구할 수 없습니다.</strong>
        </p>
        
        <div class="form-group">
            <label for="email">가입한 이메일 주소</label>
            <input type="email" id="email" placeholder="예: user@example.com" required>
        </div>
        <div class="form-group">
            <label for="employee_id">사번</label>
            <input type="text" id="employee_id" placeholder="예: 123456" required>
        </div>

        <button id="deleteBtn" onclick="requestDeletion()">계정 영구 삭제하기</button>
        <div id="message"></div>
    </div>

    <script>
        async function requestDeletion() {
            const emailInput = document.getElementById('email');
            const employeeIdInput = document.getElementById('employee_id');
            const messageDiv = document.getElementById('message');
            const deleteBtn = document.getElementById('deleteBtn');

            const email = emailInput.value.trim();
            const employeeId = employeeIdInput.value.trim();

            // 초기화
            messageDiv.style.display = 'none';
            messageDiv.className = '';
            
            if (!email || !employeeId) {
                showMessage('이메일과 사번을 모두 입력해주세요.', 'error');
                return;
            }

            if (!confirm('정말로 계정을 삭제하시겠습니까?\n이 작업은 되돌릴 수 없으며, 모든 데이터가 즉시 파기됩니다.')) {
                return;
            }

            // 로딩 상태 표시
            deleteBtn.disabled = true;
            deleteBtn.innerText = '처리 중...';

            try {
                // [중요] 본인의 Supabase 프로젝트 URL로 변경하세요!
                const functionUrl = 'https://jsziofsuskykxtobnsny.supabase.co/functions/v1/request-delete-account';
                
                const response = await fetch(functionUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, employee_id: employeeId })
                });

                const result = await response.json();

                if (response.ok) {
                    showMessage(result.message, 'success');
                    // 입력창 비우기 & 비활성화 (중복 요청 방지)
                    emailInput.value = '';
                    employeeIdInput.value = '';
                    emailInput.disabled = true;
                    employeeIdInput.disabled = true;
                    deleteBtn.style.display = 'none'; // 버튼 숨김
                } else {
                    showMessage(result.error || '알 수 없는 오류가 발생했습니다.', 'error');
                    deleteBtn.disabled = false;
                    deleteBtn.innerText = '계정 영구 삭제하기';
                }
            } catch (error) {
                showMessage('네트워크 오류가 발생했습니다. 다시 시도해주세요.', 'error');
                deleteBtn.disabled = false;
                deleteBtn.innerText = '계정 영구 삭제하기';
            }
        }

        function showMessage(text, type) {
            const messageDiv = document.getElementById('message');
            messageDiv.innerText = text;
            messageDiv.className = type;
            messageDiv.style.display = 'block';
        }
    </script>
</body>
</html>
